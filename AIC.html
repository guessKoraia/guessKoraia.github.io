<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ê³ ì„œìš© ë°ì´í„° ë¶„ì„ ë„êµ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #ffffff; padding: 20px; color: #333; }
        .no-print { background: #f4f7f9; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #ddd; }
        .container { max-width: 1000px; margin: 0 auto; }
        textarea { width: 100%; height: 120px; margin-bottom: 10px; border: 1px solid #ccc; padding: 10px; }
        
        .setup-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .column-toggle { background: #eee; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .column-toggle.active { background: #007bff; color: white; }

        /* ë³´ê³ ì„œ ì¶œë ¥ ìŠ¤íƒ€ì¼ */
        .report-section { margin-top: 40px; page-break-inside: avoid; }
        .chart-wrapper { position: relative; height: 400px; width: 100%; margin-bottom: 20px; }
        h2 { border-left: 6px solid #333; padding-left: 15px; margin-bottom: 20px; font-size: 22px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 50px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
        th { background-color: #f9f9f9; font-weight: bold; }
        
        .btn { padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn:hover { background: #555; }
    </style>
</head>
<body>

<div class="container">
    <div class="no-print">
        <h1 style="margin-top:0">ğŸ“‹ ë³´ê³ ì„œìš© ì°¨íŠ¸ ìƒì„±ê¸°</h1>
        <p>1. ì—‘ì…€ ë°ì´í„°ë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ì²« í–‰ì€ ì œëª©)</p>
        <textarea id="dataInput" placeholder="ì´ê³³ì— ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <button class="btn" onclick="parseData()">ë°ì´í„° ë¶„ì„</button>
        
        <div id="filterArea" style="margin-top:20px; display:none;">
            <p>2. ë³´ê³ ì„œì— í¬í•¨í•  ë¬¸í•­ì„ ì„ íƒí•˜ê³  ì œëª©ì„ ìˆ˜ì •í•˜ì„¸ìš”.</p>
            <div id="columnSelectors" class="setup-row"></div>
            <div id="titleEditors" class="setup-row"></div>
            <button class="btn" style="background:#28a745" onclick="generateReport()">ë³´ê³ ì„œ ìƒì„± (ì°¨íŠ¸+í‘œ)</button>
        </div>
    </div>

    <div id="reportArea">
        </div>
</div>

<script>
    // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡ (ì°¨íŠ¸ ìœ„ì— ìˆ«ì í‘œì‹œ)
    Chart.register(ChartDataLabels);

    let rawRows = [];
    let headers = [];

    function parseData() {
        const input = document.getElementById('dataInput').value.trim();
        if(!input) return;

        const rows = input.split('\n').map(r => r.split('\t'));
        headers = rows[0];
        rawRows = rows.slice(1);

        const selectorDiv = document.getElementById('columnSelectors');
        const editorDiv = document.getElementById('titleEditors');
        selectorDiv.innerHTML = '';
        editorDiv.innerHTML = '';

        headers.forEach((h, i) => {
            // ê¸°ë³¸ í•„í„°ë§ (ë²ˆí˜¸, ì—´1 ë“±ì€ ê¸°ë³¸ ì œì™¸)
            const isExcluded = h.includes("ì—´") || h.includes("ë²ˆí˜¸") || h.includes("ID");
            
            const btn = document.createElement('div');
            btn.className = `column-toggle ${!isExcluded ? 'active' : ''}`;
            btn.innerHTML = `<input type="checkbox" id="col_${i}" ${!isExcluded ? 'checked' : ''}> ${h}`;
            btn.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') {
                    const chk = btn.querySelector('input');
                    chk.checked = !chk.checked;
                    btn.classList.toggle('active', chk.checked);
                }
            };
            selectorDiv.appendChild(btn);

            const input = document.createElement('input');
            input.type = 'text';
            input.id = `edit_${i}`;
            input.value = h;
            input.style.padding = "5px";
            editorDiv.appendChild(input);
        });

        document.getElementById('filterArea').style.display = 'block';
    }

    function generateReport() {
        const reportArea = document.getElementById('reportArea');
        reportArea.innerHTML = '';

        headers.forEach((h, i) => {
            if(!document.getElementById(`col_${i}`).checked) return;

            const displayTitle = document.getElementById(`edit_${i}`).value;
            const counts = {};
            rawRows.forEach(row => {
                if(row[i]) {
                    const val = row[i].trim();
                    counts[val] = (counts[val] || 0) + 1;
                }
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);
            const total = data.reduce((a, b) => a + b, 0);

            // ì„¹ì…˜ ìƒì„±
            const section = document.createElement('div');
            section.className = 'report-section';
            
            const title = document.createElement('h2');
            title.innerText = displayTitle;
            section.appendChild(title);

            // ì°¨íŠ¸ ì˜ì—­
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-wrapper';
            const canvas = document.createElement('canvas');
            chartWrapper.appendChild(canvas);
            section.appendChild(chartWrapper);

            // í‘œ ìƒì„±
            const table = document.createElement('table');
            let tableHTML = `<tr><th>í•­ëª©</th><th>ì‘ë‹µ ìˆ˜</th><th>ë¹„ìœ¨(%)</th></tr>`;
            labels.forEach((label, idx) => {
                const percent = ((data[idx] / total) * 100).toFixed(1);
                tableHTML += `<tr><td>${label}</td><td>${data[idx]}ê±´</td><td>${percent}%</td></tr>`;
            });
            table.innerHTML = tableHTML;
            section.appendChild(table);

            reportArea.appendChild(section);

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            new Chart(canvas, {
                type: labels.length > 5 ? 'bar' : 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // ë³´ê³ ì„œìš©ì´ë¯€ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì œê±°
                    plugins: {
                        legend: { display: labels.length <= 5, position: 'bottom' },
                        datalabels: { // ìˆ«ì ë°”ë¡œ í‘œì‹œ ì„¤ì •
                            anchor: labels.length > 5 ? 'end' : 'center',
                            align: labels.length > 5 ? 'top' : 'center',
                            color: labels.length > 5 ? '#333' : '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value) => {
                                const pct = ((value / total) * 100).toFixed(1);
                                return labels.length > 5 ? value : `${value} (${pct}%)`;
                            }
                        }
                    },
                    scales: labels.length > 5 ? { y: { beginAtZero: true, border: {display: false} } } : {}
                }
            });
        });
    }
</script>

</body>
</html>