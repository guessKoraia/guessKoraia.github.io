<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>검토 목록 | 한국인공지능협회</title>

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/pretendardvariable.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/approval-workflow.js"></script>
    <script src="js/supabase-auth.js"></script>

    <style>
        html,
        body {
            font-family: Pretendard Variable, Pretendard, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .safe-area-inset-top { padding-top: env(safe-area-inset-top, 0); }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .preview-body :where(h1) {
            font-size: 26px;
            font-weight: 800;
            margin: 0 0 12px 0;
        }
        .preview-body :where(h2) {
            font-size: 18px;
            font-weight: 800;
            margin: 18px 0 10px 0;
        }
        .preview-body :where(p) {
            margin: 10px 0;
            line-height: 1.7;
        }
        .preview-body :where(table) {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            table-layout: fixed;
        }
        .preview-body :where(th, td) {
            border: 1px solid #e5e7eb;
            padding: 10px;
            vertical-align: top;
            font-size: 14px;
        }
        .preview-body :where(th) {
            background: #f9fafb;
            font-weight: 800;
            text-align: left;
            width: 160px;
        }
        .preview-body :where(img) {
            max-width: 100%;
            height: auto;
        }
        .approval-flow-row { display: flex; align-items: flex-start; flex-wrap: nowrap; gap: 0; padding: 4px 0; min-height: 82px; }
        #approvalWorkflowWrap .approval-flow-row { overflow: hidden; justify-content: flex-start; }
        #approvalWorkflowWrap .approval-flow-row .approval-step-box { min-width: 0; width: 100%; max-width: none; flex: 1; padding: 4px 6px; font-size: 9px; }
        #approvalWorkflowWrap .approval-flow-row .approval-arrow { padding: 0 2px; font-size: 10px; flex-shrink: 0; }
        #approvalWorkflowWrap .approval-flow-row .approval-step-wrapper { min-width: 0; flex: 1; }
        #approvalWorkflowWrap .approval-flow-row .approval-step-pointer-slot { height: 14px; min-height: 14px; margin-bottom: 2px; }
        #approvalWorkflowWrap .approval-flow-row .approval-arrow { min-height: 48px; padding-top: 32px; }
        .approval-step-wrapper { display: flex; flex-direction: column; align-items: center; min-height: 74px; }
        .approval-step-pointer-slot { height: 22px; min-height: 22px; display: flex; align-items: center; justify-content: center; margin-bottom: 4px; flex-shrink: 0; }
        .approval-flow-in-list .approval-step-pointer-slot { height: 18px; min-height: 18px; margin-bottom: 2px; }
        .approval-step-box { min-width: 120px; max-width: 160px; min-height: 48px; padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; line-height: 1.35; background: #f8fafc; color: #475569; box-sizing: border-box; flex-shrink: 0; }
        .approval-step-box.done { background: #ecfdf5; border-color: #6ee7b7; color: #065f46; }
        .approval-step-box.current { background: #dbeafe; border-color: #3b82f6; color: #1e40af; font-weight: 700; }
        .approval-step-box.rejected { background: #fef2f2; border-color: #fca5a5; color: #991b1b; }
        .approval-arrow { display: flex; align-items: center; padding: 0 4px; color: #94a3b8; font-size: 14px; flex-shrink: 0; min-height: 74px; padding-top: 48px; box-sizing: border-box; }
        .approval-flow-in-list .approval-arrow { min-height: 62px; padding-top: 40px; }
        .approval-step-box .step-name { font-weight: 600; margin-bottom: 4px; }
        .approval-step-box .step-email { font-size: 10px; word-break: break-all; color: inherit; opacity: 0.9; }
        .approval-flow-in-list .approval-step-box { min-width: 88px; max-width: 120px; min-height: 44px; padding: 6px 8px; font-size: 10px; }
        .approval-flow-in-list .approval-arrow { padding: 0 2px; font-size: 12px; }
        .approval-step-pointer { font-size: 16px; color: #3b82f6; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(4px); } }
        .approval-flow-in-list .approval-step-pointer { font-size: 12px; }
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast-item { pointer-events: auto; padding: 0.75rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; background: #0f172a; border: 1px solid rgba(59, 130, 246, 0.4); color: #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: toastSlideIn 0.3s ease-out; }
        .toast-item.success { border-color: rgba(34, 197, 94, 0.5); }
        .toast-item.error { border-color: rgba(239, 68, 68, 0.5); }
        @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastFadeOut { to { opacity: 0; transform: translateX(100%); } }
        .toast-item.hiding { animation: toastFadeOut 0.25s ease-in forwards; }
    </style>
</head>

<body class="bg-white text-slate-900 overflow-x-hidden">
<header class="sticky top-0 z-50 bg-white/70 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4">
        <div class="flex items-center justify-between py-2 bg-white">
            <a href="sns.html" class="flex items-center gap-2 text-2xl font-bold tracking-tight hover:opacity-90">
                <img width="25" src="data:image/svg+xml,%3c?xml%20version=%271.0%27%20encoding=%27UTF-8%27?%3e%3csvg%20id=%27_%EB%A0%88%EC%9D%B4%EC%96%B4_1%27%20data-name=%27%EB%A0%88%EC%9D%B4%EC%96%B4%201%27%20xmlns=%27http://www.w3.org/2000/svg%27%20xmlns:xlink=%27http://www.w3.org/1999/xlink%27%20viewBox=%270%200%20191.98%20192.9%27%3e%3cdefs%3e%3cstyle%3e%20.cls-1%20{%20fill:%20%2337bac8;%20}%20.cls-2%20{%20fill:%20%238cd600;%20}%20.cls-3%20{%20fill:%20%232e4068;%20}%20.cls-4%20{%20fill:%20%231d2a5f;%20}%20.cls-5%20{%20fill:%20%23e55126;%20}%20.cls-6%20{%20fill:%20url(%23linear-gradient);%20}%20%3c/style%3e%3clinearGradient%20id=%27linear-gradient%27%20x1=%2771.9%27%20y1=%27150.47%27%20x2=%2786.41%27%20y2=%2784.39%27%20gradientUnits=%27userSpaceOnUse%27%3e%3cstop%20offset=%270%27%20stop-color=%27%2337bac8%27/%3e%3cstop%20offset=%27.5%27%20stop-color=%27%231f2b63%27/%3e%3c/linearGradient%3e%3c/defs%3e%3cpath%20class=%27cls-3%27%20d=%27M86.33,67.73s0,0-.02,0h.02Z%27/%3e%3cpath%20class=%27cls-3%27%20d=%27M70.43,80.68l.03-.12s-.02.08-.03.12Z%27/%3e%3cpath%20class=%27cls-6%27%20d=%27M70.43,80.68l-13.98,66.13c4.92,3.91,10.32,7.03,15.99,9.31.8.31,1.42.56,2.19.84,3.88,1.4,7.9,2.42,11.97,3.04l12.5-60.28s-29.57-14.51-28.67-19.04Z%27/%3e%3cpath%20class=%27cls-3%27%20d=%27M70.53,80.21l-.07.34c.02-.12.06-.22.09-.34h-.02Z%27/%3e%3cpolygon%20class=%27cls-3%27%20points=%2787.62%2085.56%2087.61%2085.41%2087.46%2085.37%2087.62%2085.56%27/%3e%3cpath%20class=%27cls-3%27%20d=%27M86.21,67.73h0s.07,0,.1,0h-.1Z%27/%3e%3cg%3e%3cpath%20class=%27cls-5%27%20d=%27M55.94,46.52c.33-.27.65-.55.94-.85-.62.54-.94.85-.94.85Z%27/%3e%3cpath%20class=%27cls-4%27%20d=%27M191.42,79.57c-2.75-15.59-9.38-30.72-20.06-43.88-6.68-1.87-13.03-3.37-19.07-4.52-60.75-11.69-89.99,9.9-95.41,14.52-.3.29-.61.58-.94.85,27.57-22.37,68.08-18.16,90.46,9.41,3.01,3.7,5.52,7.64,7.57,11.74l-67.64.06h-.02s-.07,0-.1.01c-3.57,0-7.16,1.16-10.15,3.59-2.9,2.35-4.74,5.51-5.51,8.89-.03.12-.07.22-.09.34l-.03.12c-.89,4.53.15,9.41,3.28,13.27,2.81,3.46,6.76,5.45,10.87,5.86,1.37.13,90.57.13,90.57.13h.66s.69,0,.69,0h0c.62-.04,1.23-.09,1.87-.18,8.24-1.31,14.02-8.64,13.57-16.8-.16-1.13-.34-2.25-.54-3.38Z%27/%3e%3c/g%3e%3cpath%20class=%27cls-2%27%20d=%27M35.68,21.56c-2.21,5.6-4.02,11.01-5.48,16.24-17.44,62.39,15.27,98,15.27,98l.19.05c-21.37-27.54-16.93-67.25,10.28-89.33,0,0,.32-.31.94-.85,5.42-4.61,34.66-26.21,95.41-14.52,6.04,1.16,12.39,2.65,19.07,4.52C137.79-5.68,77.04-12.01,35.68,21.56Z%27/%3e%3cg%3e%3cpath%20class=%27cls-1%27%20d=%27M30.2,37.8c1.46-5.23,3.27-10.65,5.48-16.24C-5.69,55.13-12.01,115.88,21.56,157.24c6.05,2.11,11.88,3.8,17.48,5.13,40.09,9.54,68.71.56,84.28-7.29l-.11-.13c-11.61,5.32-24.37,6.95-36.62,5.05-4.07-.62-8.09-1.64-11.97-3.04-.77-.28-1.39-.53-2.19-.84-5.68-2.28-11.07-5.4-15.99-9.31-3.59-2.86-6.92-6.13-9.92-9.83-.3-.37-.58-.76-.87-1.13l-.19-.05S12.75,100.19,30.2,37.8Z%27/%3e%3cpath%20class=%27cls-4%27%20d=%27M159.6,148.74l-11.4-14.05-8.85-10.91c-5.6-6.9-15.73-7.95-22.62-2.35-6.89,5.59-7.95,15.72-2.35,22.62l8.85,10.91.11.13c-15.57,7.85-44.19,16.83-84.28,7.29-5.6-1.33-11.43-3.02-17.48-5.13,10.68,13.15,24.11,22.75,38.79,28.66,1.14.45,2.28.9,3.42,1.3,25.9,9.3,55.25,7.32,80.13-6.76,4.61-2.62,9.08-5.63,13.34-9.08,6.89-5.59,7.94-15.72,2.35-22.62Z%27/%3e%3c/g%3e%3c/svg%3e" alt="" />
                <h1 class="truncate max-w-[140px] sm:max-w-none">지식자산 관리 툴</h1>
            </a>
            <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
                <a class="border border-slate-200 px-2.5 py-2.5 sm:px-3 sm:py-2 text-xs sm:text-sm font-bold text-blue-700 min-h-[44px] inline-flex items-center justify-center" href="review.html">검토 목록</a>
                <span id="authWrap" class="flex items-center gap-1.5 sm:gap-2">
                    <button type="button" id="btnLogin" class="min-h-[44px] min-w-[44px] px-2.5 py-2.5 sm:px-3 sm:py-2 text-xs sm:text-sm font-bold border border-slate-200 bg-white hover:bg-slate-50 rounded-none">로그인</button>
                    <span id="userEmail" class="text-xs sm:text-sm font-bold text-slate-600 hidden truncate max-w-[100px] sm:max-w-[180px]"></span>
                    <button type="button" id="btnLogout" class="min-h-[44px] min-w-[44px] px-2.5 py-2.5 sm:px-3 sm:py-2 text-xs sm:text-sm font-bold border border-slate-200 bg-white hover:bg-slate-50 hidden rounded-none">로그아웃</button>
                </span>
            </div>
        </div>
    </div>
</header>

<div class="mx-auto max-w-6xl p-6">
    <div class="mt-3 sm:mt-4 border border-slate-200 p-3 sm:p-4 bg-slate-50 rounded-lg">
        <div class="flex flex-wrap items-center justify-between gap-2 sm:gap-3">
            <div class="min-w-0 flex-1">
                <div class="text-sm font-extrabold">검토 목록</div>
                <div id="reviewerNotice" class="text-xs text-slate-500 mt-0.5 sm:mt-1 truncate">로그인한 사용자는 검토 목록을 조회하고 승인·반려할 수 있습니다.</div>
            </div>
            <button id="btnRefresh" type="button" class="border border-slate-200 px-3 py-2.5 sm:py-2 text-sm font-bold bg-white min-h-[44px] touch-manipulation flex-shrink-0">새로고침</button>
        </div>

        <div class="mt-3 sm:mt-4 grid grid-cols-1 gap-2 sm:gap-3 md:grid-cols-4">
            <div>
                <div class="mb-1 text-xs font-extrabold text-slate-600">작성자</div>
                <input id="fAuthor" class="w-full border border-slate-200 p-3 text-sm outline-none min-h-[44px] rounded" placeholder="홍길동" />
            </div>
            <div class="md:col-span-2">
                <div class="mb-1 text-xs font-extrabold text-slate-600">제목</div>
                <input id="fTitle" class="w-full border border-slate-200 p-3 text-sm outline-none min-h-[44px] rounded" placeholder="세미나" />
            </div>
            <div>
                <div class="mb-1 text-xs font-extrabold text-slate-600">일자</div>
                <input id="fDate" class="w-full border border-slate-200 p-3 text-sm outline-none min-h-[44px] rounded" placeholder="2026-02" />
            </div>
        </div>
    </div>

    <div class="mt-3 sm:mt-4 border border-slate-200 p-3 sm:p-4 rounded-lg">
        <div id="listEmpty" class="text-sm text-slate-500 py-4">제출된 문서가 없습니다.</div>
        <div id="listWrap" class="space-y-2 sm:space-y-3"></div>
        <div id="listPagination" class="mt-4 flex items-center justify-center gap-1.5 sm:gap-2 flex-wrap hidden pb-2 sm:pb-0"></div>
    </div>
</div>

<div id="previewModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="w-full max-w-5xl border-0 sm:border border-slate-200 bg-white max-h-[100dvh] sm:max-h-[90vh] overflow-hidden flex flex-col rounded-none sm:rounded-lg shadow-xl">
        <div class="flex-shrink-0 relative flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 border-b border-slate-200 p-3 sm:p-4">
            <div class="text-sm font-extrabold truncate pr-8 sm:pr-0" id="modalTitle">결재하기</div>
            <div class="flex flex-wrap gap-2">
                <button id="btnApprove" type="button" class="min-h-[44px] flex-1 sm:flex-none min-w-0 border border-blue-600 px-3 py-2.5 sm:py-2 text-xs sm:text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 touch-manipulation">현재 단계 승인</button>
                <button id="btnWithdraw" type="button" class="min-h-[44px] flex-1 sm:flex-none min-w-0 border border-amber-200 px-3 py-2.5 sm:py-2 text-xs sm:text-sm font-bold text-amber-800 bg-amber-50 hover:bg-amber-100 touch-manipulation hidden">게시중단 및 철회</button>
                <button id="btnReject" type="button" class="min-h-[44px] flex-1 sm:flex-none min-w-0 border border-red-200 px-3 py-2.5 sm:py-2 text-xs sm:text-sm font-bold text-red-700 bg-white hover:bg-red-50 touch-manipulation">반려하기</button>
                <button id="btnDownload" type="button" class="min-h-[44px] flex-1 sm:flex-none min-w-0 border border-slate-200 px-3 py-2.5 sm:py-2 text-xs sm:text-sm font-bold touch-manipulation">다운로드</button>
                <button id="btnModalClose" type="button" class="min-h-[44px] sm:min-w-[60px] border border-slate-200 px-3 py-2.5 sm:py-2 text-xs sm:text-sm font-bold touch-manipulation absolute top-3 right-3 sm:static">닫기</button>
            </div>
        </div>
        <div id="approvalWorkflowWrap" class="flex-shrink-0 border-b border-slate-200 bg-slate-50 px-3 sm:px-4 py-2 sm:py-3 text-xs overflow-hidden"></div>
        <div class="flex-1 min-h-0 overflow-auto p-3 sm:p-4 max-h-[60vh] sm:max-h-none">
            <div id="previewContent" class="preview-body"></div>
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container" aria-live="polite"></div>

<script>
    const DB_NAME = "KoraiaKnowledgeDB";
    const DB_VERSION = 1;

    const STORE_POSTS = "posts";
    const STORE_IMAGES = "images";

    const $ = (id) => document.getElementById(id);

    function showToast(message, type) {
        type = type || "info";
        var container = $("toastContainer");
        if (!container) return;
        var el = document.createElement("div");
        el.className = "toast-item " + type;
        el.textContent = message;
        container.appendChild(el);
        setTimeout(function () {
            el.classList.add("hiding");
            setTimeout(function () { if (el.parentNode) el.parentNode.removeChild(el); }, 250);
        }, 3500);
    }

    let db;
    let currentPost = null;
    const REVIEW_PAGE_SIZE = 10;
    let reviewFiltered = [];
    let reviewCurrentPage = 1;

    const openDB = () =>
        new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onerror = () => reject(req.error);
            req.onsuccess = () => resolve(req.result);
            req.onupgradeneeded = (ev) => {
                const d = ev.target.result;
                if (!d.objectStoreNames.contains(STORE_POSTS)) d.createObjectStore(STORE_POSTS, { keyPath: "id" });
                if (!d.objectStoreNames.contains(STORE_IMAGES)) {
                    const s = d.createObjectStore(STORE_IMAGES, { keyPath: "id", autoIncrement: true });
                    s.createIndex("postId", "postId", { unique: false });
                }
            };
        });

    const txStore = (store, mode = "readonly") => db.transaction(store, mode).objectStore(store);

    const escapeHtml = (s) =>
        String(s ?? "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");

    const blobToDataURL = (blob) =>
        new Promise((resolve) => {
            const r = new FileReader();
            r.onloadend = () => resolve(r.result);
            r.readAsDataURL(blob);
        });

    const downloadTextFile = (filename, content) => {
        const blob = new Blob([content], { type: "text/html;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    };

    const loadAllPosts = async () => {
        if (typeof supabaseGetPostsForReview === "function") {
            try {
                const fromSupabase = await supabaseGetPostsForReview();
                return fromSupabase || [];
            } catch (e) {
                console.warn("Supabase 목록 조회 실패:", e);
            }
        }
        if (!db) return [];
        const store = txStore(STORE_POSTS, "readonly");
        const posts = await new Promise((resolve) => {
            const req = store.getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = () => resolve([]);
        });
        return posts;
    };

    const applyFilters = (posts) => {
        const fa = $("fAuthor").value.trim();
        const ft = $("fTitle").value.trim();
        const fd = $("fDate").value.trim();

        return posts.filter((p) => {
            if (p.status !== "submitted" && p.status !== "approved") return false;
            if (fa && !String(p.authorName || "").includes(fa)) return false;
            if (ft && !String(p.title || "").includes(ft)) return false;
            if (fd && !String(p.date || "").includes(fd)) return false;
            return true;
        });
    };

    const getCurrentStepLabel = (post) => {
        const stage = post.approvalStage != null ? post.approvalStage : 0;
        if (typeof window.isApprovalComplete === "function" && window.isApprovalComplete(stage))
            return "최종 승인 완료";
        const steps = window.APPROVAL_STEPS;
        const next = steps && steps[stage];
        return next ? next.name + " 대기" : "단계 " + stage + " 대기";
    };

    const formatKST = (isoStr) => {
        if (!isoStr) return "";
        const d = new Date(isoStr);
        return d.toLocaleString("sv-SE", { timeZone: "Asia/Seoul" }).slice(0, 16).replace("T", " ");
    };

    const buildApprovalFlowHtml = (post, addWrapClass) => {
        const steps = window.APPROVAL_STEPS || [];
        const stage = post.approvalStage != null ? post.approvalStage : 0;
        const history = Array.isArray(post.approvalHistory) ? post.approvalHistory : [];
        const byStep = {};
        history.forEach((h) => { byStep[h.step] = h; });
        const parts = [];
        steps.forEach(function (s, i) {
            if (i > 0) parts.push('<span class="approval-arrow">→</span>');
            const rec = byStep[i];
            const isCurrent = i === stage;
            // step 0은 제출되면 자동 완료 처리 (작성자가 제출한 것으로 간주)
            const isStep0Done = (i === 0 && stage >= 1);
            const isDone = (rec && !rec.rejected) || isStep0Done;
            const isRejected = rec && rec.rejected;
            let boxCls = "approval-step-box";
            if (isRejected) boxCls += " rejected";
            else if (isDone) boxCls += " done";
            else if (isCurrent) boxCls += " current";
            const rawApprover = rec ? (rec.approver_name || "") : "";
            // approver_name에 이미 표시명이 저장된 경우가 있음. @가 있으면 이메일로 간주해 getNameByEmail 사용
            const displayApprover = (rawApprover && rawApprover.indexOf("@") !== -1 && typeof window.getNameByEmail === "function")
                ? window.getNameByEmail(rawApprover)
                : (rawApprover || "결재자");
            const approverLabel = escapeHtml(displayApprover);
            const date = rec && rec.approved_at ? formatKST(rec.approved_at) : "";
            let label;
            const dateHtml = date ? "<br>" + escapeHtml(date) : "";
            if (isStep0Done && !rec) {
                label = escapeHtml(post.authorName || "작성자") + " 제출";
            } else if (rec && rec.withdrawn) {
                label = "게시중단 및 철회" + dateHtml;
            } else {
                label = isRejected ? "반려 " + approverLabel + dateHtml : (isDone ? approverLabel + dateHtml : (isCurrent ? "진행 중" : "대기"));
            }
            const pointerContent = isCurrent ? '<span class="approval-step-pointer">▼ 현재</span>' : '';
            parts.push('<div class="approval-step-wrapper"><div class="approval-step-pointer-slot">' + pointerContent + '</div><div class="' + boxCls + '"><div class="step-name">' + escapeHtml(s.name) + "</div><div class=\"step-email\">" + label + "</div></div></div>");
        });
        const wrapCls = "approval-flow-row" + (addWrapClass ? " " + addWrapClass : "");
        return '<div class="' + wrapCls + '">' + parts.join("") + "</div>";
    };

    const renderApprovalWorkflow = (post) => {
        const wrap = $("approvalWorkflowWrap");
        if (!wrap) return;
        wrap.innerHTML = buildApprovalFlowHtml(post, "approval-flow-in-list");
    };

    const buildExportHtmlWithEmbeddedImages = async (post) => {
        const wrapper = document.createElement("div");
        wrapper.innerHTML = post.editorHtml || "";

        const imgs = Array.from(wrapper.querySelectorAll("img[data-image-id]"));

        for (const img of imgs) {
            if (!db) continue;
            const id = Number(img.getAttribute("data-image-id"));
            if (!id || Number.isNaN(id)) continue;

            // 각 이미지마다 새 트랜잭션 생성
            const record = await new Promise((resolve) => {
                try {
                    const tx = db.transaction(STORE_IMAGES, "readonly");
                    const store = tx.objectStore(STORE_IMAGES);
                    const req = store.get(id);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                } catch (e) {
                    console.warn("idbGet error:", e);
                    resolve(null);
                }
            });

            if (!record?.blob) continue;

            const dataUrl = await blobToDataURL(record.blob);
            img.setAttribute("src", dataUrl);

            const alt = (img.getAttribute("alt") || "").trim() || (record.alt || "");
            if (alt) img.setAttribute("alt", alt);
        }

        const title = escapeHtml(post.title || "문서");
        const bodyHtml = wrapper.innerHTML;
        const endBody = "</" + "body>";
        const endTag = "</" + "html>";
        return (
            "<!doctype html>\n<html lang=\"ko\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>" + title + "</title>\n  <style>\n    body{font-family:Pretendard, Pretendard Variable, system-ui, -apple-system, Segoe UI, Roboto, \"Noto Sans KR\", Arial, sans-serif; margin:0; padding:28px; color:#111827;}\n    p{line-height:1.7; margin:10px 0;}\n    table{width:100%; border-collapse:collapse; margin:10px 0; table-layout:fixed;}\n    th,td{border:1px solid #e5e7eb; padding:10px; vertical-align:top; font-size:14px;}\n    th{background:#f9fafb; font-weight:800; text-align:left; width:160px;}\n    img{max-width:100%; height:auto;}\n    a{color:#2563eb;}\n  </style>\n</head>\n<body>\n  " + bodyHtml + "\n" + endBody + "\n" + endTag
        ).trim();
    };

    const openModal = () => $("previewModal").classList.add("show");
    const closeModal = () => $("previewModal").classList.remove("show");

    const renderList = async (useCached) => {
        if (!useCached) {
            const all = await loadAllPosts();
            reviewFiltered = applyFilters(all).sort((a, b) => String(b.updatedAt || "").localeCompare(String(a.updatedAt || "")));
            reviewCurrentPage = 1;
        }
        const totalPages = Math.max(1, Math.ceil(reviewFiltered.length / REVIEW_PAGE_SIZE));
        const start = (reviewCurrentPage - 1) * REVIEW_PAGE_SIZE;
        const pageItems = reviewFiltered.slice(start, start + REVIEW_PAGE_SIZE);

        const wrap = $("listWrap");
        const empty = $("listEmpty");
        const paginationEl = $("listPagination");
        wrap.innerHTML = "";

        if (reviewFiltered.length === 0) {
            empty.classList.remove("hidden");
            if (paginationEl) { paginationEl.classList.add("hidden"); paginationEl.innerHTML = ""; }
            return;
        }
        empty.classList.add("hidden");
        if (paginationEl) paginationEl.classList.remove("hidden");

        pageItems.forEach((p) => {
            const row = document.createElement("div");
            row.className = "border border-slate-200 p-4";

            const typeLabel = p.type === "event" ? "행사" : "탐방";
            const t = escapeHtml(p.title || "");
            const a = escapeHtml(p.authorName || "");
            const d = escapeHtml(p.date || "");
            const place = escapeHtml(p.place || "");
            const stepLabel = getCurrentStepLabel(p);

            const flowHtml = buildApprovalFlowHtml(p, "approval-flow-in-list");
            row.innerHTML = `
            <div class="flex flex-col sm:flex-row sm:flex-wrap items-stretch sm:items-start justify-between gap-3">
              <div class="min-w-0 flex-1">
                <div class="text-xs font-extrabold text-slate-500">${typeLabel} · ${p.id.slice(0, 8)}</div>
                <div class="mt-1 text-sm font-extrabold break-words line-clamp-2 sm:truncate">${t}</div>
                <div class="mt-2 text-xs font-bold text-slate-600 break-words">${a} · ${d} · ${place}</div>
                <div class="mt-3 overflow-x-auto -mx-1">${flowHtml}</div>
              </div>
              <div class="flex flex-row gap-2 flex-shrink-0 mt-1 sm:mt-0">
                <button data-open="1" type="button" class="flex-1 sm:flex-none min-h-[44px] border border-slate-200 px-3 py-2.5 sm:py-2 text-sm font-bold touch-manipulation">결재하기</button>
                <a class="flex-1 sm:flex-none min-h-[44px] border border-slate-200 px-3 py-2.5 sm:py-2 text-sm font-bold text-center inline-flex items-center justify-center" href="${p.type === "event" ? "write_event.html" : "write_visit.html"}?id=${encodeURIComponent(p.id)}">수정하기</a>
              </div>
            </div>
          `;

            row.querySelector('button[data-open="1"]').addEventListener("click", async () => {
                currentPost = p;
                $("modalTitle").textContent = "결재하기 · " + typeLabel + " · " + p.id.slice(0, 8);
                renderApprovalWorkflow(p);
                const btnApprove = $("btnApprove");
                const btnReject = $("btnReject");
                const pStage = p.approvalStage != null ? p.approvalStage : 0;
                const complete = typeof window.isApprovalComplete === "function" && window.isApprovalComplete(pStage);
                let userEmail = "";
                if (typeof supabaseAuthGetUser === "function") {
                    const user = await supabaseAuthGetUser();
                    userEmail = (user && user.email) ? user.email : "";
                }
                const canApprove = typeof window.canApproveStep === "function" && window.canApproveStep(pStage, userEmail);
                if (btnApprove) {
                    if (complete) {
                        btnApprove.textContent = "최종 승인 완료";
                        btnApprove.disabled = true;
                        btnApprove.title = "";
                    } else {
                        const stepInfo = window.APPROVAL_STEPS && window.APPROVAL_STEPS[pStage];
                        btnApprove.textContent = stepInfo ? stepInfo.name + " 승인" : "현재 단계 승인";
                        btnApprove.disabled = !canApprove;
                        if (!canApprove && stepInfo) {
                            const emails = stepInfo.allowedEmails || (stepInfo.allowedEmail ? [stepInfo.allowedEmail] : []);
                            if (emails.length > 0) {
                                const names = emails.map(function(email) {
                                    return typeof window.getNameByEmail === "function" ? window.getNameByEmail(email) : "결재자";
                                });
                                btnApprove.title = "결재 권한이 없습니다. 해당 단계는 " + names.join(", ") + "만 승인할 수 있습니다.";
                            } else {
                                btnApprove.title = "결재 권한이 없습니다.";
                            }
                        } else {
                            btnApprove.title = "";
                        }
                    }
                    btnApprove.style.display = "";
                }
                if (btnReject) {
                    btnReject.style.display = (complete || pStage <= 0) ? "none" : "";
                    btnReject.disabled = false;
                }
                const btnWithdraw = $("btnWithdraw");
                if (btnWithdraw) {
                    const canWithdraw = complete && typeof window.canWithdrawPublish === "function" && window.canWithdrawPublish(userEmail);
                    btnWithdraw.style.display = canWithdraw ? "inline-flex" : "none";
                    btnWithdraw.disabled = false;
                }
                const htmlDoc = await buildExportHtmlWithEmbeddedImages(p);
                const endBodyTag = "</" + "body>";
                const bodyOnly = htmlDoc.split("<body>")[1]?.split(endBodyTag)[0] ?? "";
                $("previewContent").innerHTML = bodyOnly;
                openModal();
            });

            wrap.appendChild(row);
        });

        if (paginationEl && totalPages > 1) {
            let html = "";
            if (reviewCurrentPage > 1) {
                html += '<button type="button" data-page="' + (reviewCurrentPage - 1) + '" class="border border-slate-200 px-3 py-2.5 sm:py-2 text-sm font-bold bg-white hover:bg-slate-50 min-h-[44px] touch-manipulation">이전</button>';
            }
            const maxShow = 5;
            let from = Math.max(1, reviewCurrentPage - Math.floor(maxShow / 2));
            let to = Math.min(totalPages, from + maxShow - 1);
            if (to - from + 1 < maxShow) from = Math.max(1, to - maxShow + 1);
            for (let i = from; i <= to; i++) {
                const active = i === reviewCurrentPage;
                html += '<button type="button" data-page="' + i + '" class="border px-3 py-2.5 sm:py-2 text-sm font-bold min-h-[44px] min-w-[44px] touch-manipulation ' + (active ? "bg-blue-600 text-white border-blue-600" : "border-slate-200 bg-white hover:bg-slate-50") + '">' + i + "</button>";
            }
            if (reviewCurrentPage < totalPages) {
                html += '<button type="button" data-page="' + (reviewCurrentPage + 1) + '" class="border border-slate-200 px-3 py-2.5 sm:py-2 text-sm font-bold bg-white hover:bg-slate-50 min-h-[44px] touch-manipulation">다음</button>';
            }
            paginationEl.innerHTML = html;
            paginationEl.querySelectorAll("button[data-page]").forEach((btn) => {
                btn.addEventListener("click", () => {
                    reviewCurrentPage = parseInt(btn.getAttribute("data-page"), 10);
                    renderList(true);
                });
            });
        } else if (paginationEl) {
            paginationEl.innerHTML = "";
        }
    };

    const approveCurrent = async () => {
        if (!currentPost) return;
        const stage = currentPost.approvalStage != null ? currentPost.approvalStage : 0;
        if (typeof window.isApprovalComplete === "function" && window.isApprovalComplete(stage)) {
            alert("이미 최종 승인된 글입니다.");
            return;
        }
        let approverEmail = "";
        if (typeof supabaseAuthGetUser === "function") {
            const user = await supabaseAuthGetUser();
            approverEmail = (user && user.email) ? user.email : "";
        }
        const steps = window.APPROVAL_STEPS;
        const stepInfo = steps && steps[stage];
        if (typeof window.canApproveStep === "function" && !window.canApproveStep(stage, approverEmail)) {
            const emails = stepInfo ? (stepInfo.allowedEmails || (stepInfo.allowedEmail ? [stepInfo.allowedEmail] : [])) : [];
            const names = emails.map(function (e) { return typeof window.getNameByEmail === "function" ? window.getNameByEmail(e) : "결재자"; });
            const msg = names.length > 0
                ? "결재 권한이 없습니다. 해당 단계는 " + (stepInfo.responsible || "") + " (" + names.join(", ") + ")만 승인할 수 있습니다."
                : "결재 권한이 없습니다.";
            alert(msg);
            return;
        }
        const stepLabel = stepInfo ? stepInfo.name : "단계 " + stage;
        const approverDisplayName = typeof window.getNameByEmail === "function" ? window.getNameByEmail(approverEmail) : "결재자";
        const ok = confirm(stepLabel + " 단계를 승인하시겠습니까?\n접속: " + approverDisplayName);
        if (!ok) return;

        if (typeof supabaseApproveStep === "function") {
            try {
                await supabaseApproveStep(currentPost.id, approverDisplayName);
            } catch (e) {
                alert("승인 반영 실패: " + (e.message || e));
                return;
            }
        } else if (db) {
            const store = txStore(STORE_POSTS, "readwrite");
            await new Promise((resolve) => {
                const req = store.put({ ...currentPost, status: "approved", updatedAt: new Date().toISOString() });
                req.onsuccess = () => resolve(true);
                req.onerror = () => resolve(true);
            });
        }
        if (typeof supabaseGetPostById === "function") {
            const updated = await supabaseGetPostById(currentPost.id);
            if (updated) currentPost = updated;
        }
        renderApprovalWorkflow(currentPost);
        const btnApprove = $("btnApprove");
        const newStage = currentPost.approvalStage != null ? currentPost.approvalStage : stage + 1;
        const nextInfo = window.APPROVAL_STEPS && window.APPROVAL_STEPS[newStage];
        if (typeof supabaseInvokeSlackApproval === "function") {
            supabaseInvokeSlackApproval({
                title: currentPost.title,
                authorName: currentPost.authorName,
                stage: newStage,
                stepName: nextInfo ? nextInfo.name : "단계 " + newStage,
                postId: currentPost.id,
                eventType: "approve"
            }).catch(function (err) { console.warn("Slack 알림 실패:", err); });
        }
        if (btnApprove) {
            if (typeof window.isApprovalComplete === "function" && window.isApprovalComplete(newStage)) {
                btnApprove.textContent = "최종 승인 완료";
                btnApprove.disabled = true;
                showToast("최종 승인 및 발행이 완료되었습니다.", "success");
            } else {
                btnApprove.textContent = nextInfo ? nextInfo.name + " 승인" : "현재 단계 승인";
                showToast((nextInfo ? nextInfo.name : newStage + "단계") + " 로 결재가 요청되었습니다.", "success");
            }
        }
        await renderList();
    };

    const rejectCurrent = async () => {
        if (!currentPost) return;
        const stage = currentPost.approvalStage != null ? currentPost.approvalStage : 0;
        if (stage <= 0) {
            alert("최초 단계는 반려할 수 없습니다.");
            return;
        }
        let rejectorEmail = "";
        if (typeof supabaseAuthGetUser === "function") {
            const user = await supabaseAuthGetUser();
            rejectorEmail = (user && user.email) ? user.email : "";
        }
        const rejectorDisplayName = typeof window.getNameByEmail === "function" ? window.getNameByEmail(rejectorEmail) : "결재자";
        const ok = confirm("현재 단계를 반려하시겠습니까? 이전 단계로 되돌아가 수정 후 다시 진행할 수 있습니다.\n반려자: " + rejectorDisplayName);
        if (!ok) return;

        if (typeof supabaseRejectStep === "function") {
            try {
                await supabaseRejectStep(currentPost.id, rejectorDisplayName);
            } catch (e) {
                alert("반려 반영 실패: " + (e.message || e));
                return;
            }
        }
        if (typeof supabaseGetPostById === "function") {
            const updated = await supabaseGetPostById(currentPost.id);
            if (updated) currentPost = updated;
        }
        renderApprovalWorkflow(currentPost);
        const btnApprove = $("btnApprove");
        const btnReject = $("btnReject");
        const newStage = currentPost.approvalStage != null ? currentPost.approvalStage : 0;
        if (btnApprove) {
            const stepInfo = window.APPROVAL_STEPS && window.APPROVAL_STEPS[newStage];
            btnApprove.textContent = stepInfo ? stepInfo.name + " 승인" : "현재 단계 승인";
            btnApprove.disabled = false;
        }
        if (btnReject) btnReject.style.display = newStage <= 0 ? "none" : "";
        if (typeof supabaseInvokeSlackApproval === "function") {
            const rejectedStepInfo = window.APPROVAL_STEPS && window.APPROVAL_STEPS[stage];
            supabaseInvokeSlackApproval({
                title: currentPost.title,
                authorName: currentPost.authorName,
                stage: stage,
                stepName: rejectedStepInfo ? rejectedStepInfo.name : "단계 " + stage,
                postId: currentPost.id,
                eventType: "reject"
            }).catch(function (err) { console.warn("Slack 알림 실패:", err); });
        }
        showToast("반려되었습니다. 이전 단계에서 다시 진행해 주세요.", "info");
        await renderList();
    };

    const withdrawCurrent = async () => {
        if (!currentPost) return;
        const stage = currentPost.approvalStage != null ? currentPost.approvalStage : 0;
        if (typeof window.isApprovalComplete !== "function" || !window.isApprovalComplete(stage)) {
            alert("최종 승인 완료된 글만 게시중단할 수 있습니다.");
            return;
        }
        let userEmail = "";
        if (typeof supabaseAuthGetUser === "function") {
            const user = await supabaseAuthGetUser();
            userEmail = (user && user.email) ? user.email : "";
        }
        if (typeof window.canWithdrawPublish !== "function" || !window.canWithdrawPublish(userEmail)) {
            alert("게시중단 및 철회 권한이 없습니다.");
            return;
        }
        if (!confirm("게시중단 및 철회하시겠습니까? 문서가 4단계(최종 승인 및 발행) 대기 상태로 되돌아갑니다.")) return;

        if (typeof supabaseWithdrawApproval !== "function") {
            alert("기능을 사용할 수 없습니다.");
            return;
        }
        try {
            await supabaseWithdrawApproval(currentPost.id);
        } catch (e) {
            alert("게시중단 반영 실패: " + (e.message || e));
            return;
        }
        if (typeof supabaseGetPostById === "function") {
            const updated = await supabaseGetPostById(currentPost.id);
            if (updated) currentPost = updated;
        }
        renderApprovalWorkflow(currentPost);
        const btnApprove = $("btnApprove");
        const btnWithdraw = $("btnWithdraw");
        const btnReject = $("btnReject");
        const newStage = currentPost.approvalStage != null ? currentPost.approvalStage : 0;
        if (btnApprove) {
            const stepInfo = window.APPROVAL_STEPS && window.APPROVAL_STEPS[newStage];
            btnApprove.textContent = stepInfo ? stepInfo.name + " 승인" : "현재 단계 승인";
            btnApprove.disabled = !(typeof window.canApproveStep === "function" && window.canApproveStep(newStage, userEmail));
            btnApprove.style.display = "";
        }
        if (btnWithdraw) btnWithdraw.style.display = "none";
        if (btnReject) btnReject.style.display = newStage <= 0 ? "none" : "";
        showToast("게시중단 및 철회되었습니다. 4단계부터 다시 진행할 수 있습니다.", "info");
        await renderList();
    };

    const downloadCurrent = async () => {
        if (!currentPost) return;
        const doc = await buildExportHtmlWithEmbeddedImages(currentPost);
        const safe = (currentPost.title || "document").replace(/[\\/:*?"<>|]/g, "_").slice(0, 60);
        downloadTextFile(`${safe}.html`, doc);
    };

    const updateAuthUI = (user) => {
        var btnLogin = $("btnLogin");
        var btnLogout = $("btnLogout");
        var userEmail = $("userEmail");
        if (user) {
            if (btnLogin) btnLogin.classList.add("hidden");
            if (userEmail) {
                userEmail.textContent = (typeof window.getNameByEmail === "function" ? window.getNameByEmail(user.email || "") : "") || (user.email || "");
                userEmail.classList.remove("hidden");
            }
            if (btnLogout) btnLogout.classList.remove("hidden");
        } else {
            if (btnLogin) btnLogin.classList.remove("hidden");
            if (userEmail) userEmail.classList.add("hidden");
            if (btnLogout) btnLogout.classList.add("hidden");
        }
    };

    (async () => {
        try { db = await openDB(); } catch (_) { db = null; }

        if (typeof supabaseGetApprovalConfig === "function" && typeof window.initApprovalConfig === "function") {
            try {
                var config = await supabaseGetApprovalConfig();
                if (config) window.initApprovalConfig(config);
            } catch (_) {}
        }
        if (typeof supabaseAuthGetSession === "function") {
            var ses = await supabaseAuthGetSession();
            if (ses && ses.data && ses.data.session) {
                updateAuthUI(ses.data.session.user);
            } else {
                updateAuthUI(null);
            }
        } else {
            updateAuthUI(null);
        }
        if (typeof supabaseAuthOnAuthStateChange === "function") {
            supabaseAuthOnAuthStateChange(async function (event, session) {
                updateAuthUI(session ? session.user : null);
                if (session && typeof supabaseGetApprovalConfig === "function" && typeof window.initApprovalConfig === "function") {
                    try {
                        var cfg = await supabaseGetApprovalConfig();
                        if (cfg) window.initApprovalConfig(cfg);
                    } catch (_) {}
                }
            });
        }
        if ($("btnLogin")) $("btnLogin").addEventListener("click", function () {
            if (typeof supabaseAuthSignIn === "function") supabaseAuthSignIn();
        });
        if ($("btnLogout")) $("btnLogout").addEventListener("click", async function () {
            try {
                if (typeof supabaseAuthSignOut === "function") await supabaseAuthSignOut();
            } catch (e) {
                console.warn("로그아웃:", e);
            }
            updateAuthUI(null);
        });

        $("btnRefresh").addEventListener("click", renderList);
        $("fAuthor").addEventListener("input", renderList);
        $("fTitle").addEventListener("input", renderList);
        $("fDate").addEventListener("input", renderList);

        $("btnModalClose").addEventListener("click", () => {
            closeModal();
            currentPost = null;
        });
        $("btnApprove").addEventListener("click", approveCurrent);
        if ($("btnReject")) $("btnReject").addEventListener("click", rejectCurrent);
        if ($("btnWithdraw")) $("btnWithdraw").addEventListener("click", withdrawCurrent);
        $("btnDownload").addEventListener("click", downloadCurrent);

        await renderList();
    })();
</script>
</body>
</html>
